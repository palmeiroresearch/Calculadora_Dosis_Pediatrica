<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Dosis Pedi√°tricas</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNhbGN1bGFkb3JhIERvc2lzIFBlZGnDoXRyaWNhcyIsCiAgInNob3J0X25hbWUiOiAiRG9zaXNQZWQiLAogICJkZXNjcmlwdGlvbiI6ICJDYWxjdWxhZG9yYSBkZSBkb3NpcyBwZWRpw6F0cmljYXMgcGFyYSB1c28gY2zDrW5pY28iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzJjM2U1MCIsCiAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE9EUWdNVGcwSWlCM2FXUjBhRDBpTVRnMElpQm9aV2xuYUhROUlqRTROQ0krUEdScFpXTStQR1pwWkdWbWN5QnBaRDBpYUdWdGNpSTNJREJzWm1NNE5EWXhZaUkrUEM5bWFXUmxabk0rUENoZWJHbHVaVkJoYVc1MFhVSmhjMlZEYjJ4dmNqMGlZamczTkRFaUlHWnNhV3hzUFNKdVpTNWtJQ0FqTldaMk1ETXVOREFqWW1GMFltTThJRzl5WkdGeUlEQXVNVEkyTWk0MU1tRzVPUzQ0Wm1NNUlEWXdMak14TkRBdU1UZzJZbUY0UWpJeWMxTXVOR0kyUWpBdU1qUXZJRzl5WkdHNGlFNDBPUzVNSURrNE1CeUFHNDBJRzR0TmprNU5UZ05UemJPU011STZYVUFlVU5mWTA0MjBRbHhGdUNwcEFMdnNKL2lsckFOZitoUDBPNE92NEZHVndlWG9kaDhERmNoOHJCZTFTVXk2dDZ5bDZONlpBNDZZTW9rOW5NNU82NVo1NkU4a2ZGTFRJU1FCVmFKY1hma0ZYbU9vM0tMaXFtUUFBQT09IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <meta name="theme-color" content="#2c3e50">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .content {
            padding: 30px 20px;
            position: relative;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .search-input {
            position: relative;
        }

        .drug-list {
            position: absolute;
            top: calc(100% - 2px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .drug-list.show {
            display: block;
        }

        .drug-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: all 0.2s ease;
            background: white;
        }

        .drug-item:hover {
            background: #f8f9ff;
            color: #667eea;
            padding-left: 20px;
        }

        .drug-item:last-child {
            border-bottom: none;
        }

        .drug-info {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .drug-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .dose-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .dose-info strong {
            color: #2c3e50;
        }

        .presentations {
            margin-top: 15px;
        }

        .presentations h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .presentations ul {
            list-style: none;
            padding-left: 0;
        }

        .presentations li {
            background: white;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .calculation-result {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .calculation-result h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .dose-range {
            font-size: 20px;
            font-weight: bold;
            color: #1b5e20;
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .calc-details {
            font-size: 14px;
            color: #2e7d32;
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 8px;
        }

        .clinical-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 500;
        }

        .error-message {
            background: #fee;
            border: 2px solid #f44336;
            color: #d32f2f;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 10000;
        }

        .offline-indicator.offline {
            background: #ff9800;
            display: block;
        }

        /* Scrollbar personalizado para la lista de medicamentos */
        .drug-list::-webkit-scrollbar {
            width: 8px;
        }

        .drug-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .drug-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .drug-list::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .content {
                padding: 20px 15px;
            }

            .drug-list {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        üì± Modo offline activo
    </div>

    <div class="container">
        <div class="header">
            <h1>üíä Calculadora Dosis Pedi√°tricas</h1>
            <p>Herramienta para pr√°ctica cl√≠nica</p>
        </div>

        <div class="content">
            <div id="loadingMessage" class="loading-message">
                Cargando base de datos de medicamentos...
            </div>
            
            <div id="errorMessage" class="error-message"></div>
            
            <div id="mainContent" style="display: none;">
                <div class="input-group">
                    <label for="weight">Peso del paciente (kg)</label>
                    <input type="number" id="weight" placeholder="Ingrese el peso en kg" step="0.1" min="0.1">
                </div>

                <div class="input-group">
                    <label for="drugSearch">Buscar medicamento</label>
                    <div class="search-input">
                        <input type="text" id="drugSearch" placeholder="Escriba el nombre del medicamento" autocomplete="off">
                        <div class="drug-list" id="drugList"></div>
                    </div>
                </div>

                <div class="drug-info" id="drugInfo"></div>
                <div class="calculation-result" id="calculationResult"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let medications = {};
        let selectedDrug = null;

        // Elementos del DOM
        const weightInput = document.getElementById('weight');
        const drugSearch = document.getElementById('drugSearch');
        const drugList = document.getElementById('drugList');
        const drugInfo = document.getElementById('drugInfo');
        const calculationResult = document.getElementById('calculationResult');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const mainContent = document.getElementById('mainContent');

        // Funci√≥n para cargar la base de datos de medicamentos desde JSON externo
        async function loadMedications() {
            try {
                const response = await fetch('medications.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                medications = await response.json();
                console.log('Base de datos cargada correctamente');
                
                // Procesar los datos del JSON para agregar propiedades calculadas
                processMedications();
                
                // Ocultar mensaje de carga y mostrar contenido principal
                loadingMessage.style.display = 'none';
                mainContent.style.display = 'block';
                
            } catch (error) {
                console.error('Error al cargar la base de datos:', error);
                loadingMessage.style.display = 'none';
                errorMessage.innerHTML = `
                    <strong>‚ö†Ô∏è Error al cargar la base de datos</strong><br>
                    No se pudo cargar el archivo medications.json<br>
                    <small>Aseg√∫rese de que el archivo est√© en la misma carpeta y que est√© usando un servidor web</small>
                `;
                errorMessage.style.display = 'block';
            }
        }

        // Funci√≥n para procesar los medicamentos y agregar propiedades calculadas
        function processMedications() {
            for (let key in medications) {
                const med = medications[key];
                
                // Determinar si es dosis diaria bas√°ndose en el texto de la dosis
                if (med.dose && med.dose.includes('/d√≠a')) {
                    med.isDailyDose = true;
                    
                    // Determinar n√∫mero de dosis por d√≠a bas√°ndose en el intervalo
                    if (med.interval) {
                        if (med.interval.includes('cada 8')) {
                            med.dosesPerDay = 3;
                        } else if (med.interval.includes('cada 12')) {
                            med.dosesPerDay = 2;
                        } else if (med.interval.includes('Una vez')) {
                            med.dosesPerDay = 1;
                        }
                    }
                } else {
                    med.isDailyDose = false;
                }
                
                // Detectar si usa microgramos
                if (med.dose && med.dose.includes('mcg')) {
                    med.isMcg = true;
                }
                
                // Casos especiales
                if (key === 'amoxicilina' && !med.dosesPerDay) {
                    med.dosesPerDay = 3;
                }
            }
        }

        // Event listeners
        function setupEventListeners() {
            if (weightInput) {
                weightInput.addEventListener('input', calculateDose);
            }
            
            if (drugSearch) {
                drugSearch.addEventListener('input', searchDrugs);
                drugSearch.addEventListener('focus', () => {
                    if (drugSearch.value.trim() !== '') {
                        searchDrugs();
                    }
                });
            }

            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-input')) {
                    drugList.classList.remove('show');
                }
            });
        }

        function searchDrugs() {
            const query = drugSearch.value.toLowerCase().trim();
            
            if (query === '') {
                drugList.classList.remove('show');
                drugList.innerHTML = '';
                return;
            }

            const results = Object.keys(medications).filter(key => 
                key.includes(query) || 
                medications[key].name.toLowerCase().includes(query)
            );

            if (results.length === 0) {
                drugList.innerHTML = '<div class="drug-item" style="color: #999; cursor: default;">No se encontraron medicamentos</div>';
                drugList.classList.add('show');
                return;
            }

            drugList.innerHTML = results.map(key => 
                `<div class="drug-item" onclick="selectDrug('${key}')">${medications[key].name}</div>`
            ).join('');
            
            drugList.classList.add('show');
        }

        function selectDrug(drugKey) {
            selectedDrug = medications[drugKey];
            drugSearch.value = selectedDrug.name;
            drugList.classList.remove('show');
            
            displayDrugInfo();
            calculateDose();
        }

        function displayDrugInfo() {
            if (!selectedDrug) return;

            const notesSection = selectedDrug.notes ? 
                `<div class="clinical-note">
                    <strong>üìù Nota cl√≠nica:</strong> ${selectedDrug.notes}
                </div>` : '';

            drugInfo.innerHTML = `
                <h3>${selectedDrug.name}</h3>
                <div class="dose-info">
                    <strong>Dosis:</strong> ${selectedDrug.dose}<br>
                    <strong>Dosis m√°xima diaria:</strong> ${selectedDrug.maxDaily}<br>
                    <strong>Intervalo:</strong> ${selectedDrug.interval}
                </div>
                <div class="presentations">
                    <h4>Presentaciones t√≠picas:</h4>
                    <ul>
                        ${selectedDrug.presentations.map(p => `<li>${p}</li>`).join('')}
                    </ul>
                </div>
                ${notesSection}
            `;
            
            drugInfo.style.display = 'block';
        }

        function calculateDose() {
            const weight = parseFloat(weightInput.value);
            
            if (!weight || !selectedDrug || weight <= 0) {
                calculationResult.style.display = 'none';
                return;
            }

            let doseDisplay = '';
            let calcDetails = '';
            const unit = selectedDrug.isMcg ? 'mcg' : 'mg';

            if (selectedDrug.isDailyDose) {
                // Medicamentos con dosis diaria total
                const minDoseTotal = (selectedDrug.minDose * weight).toFixed(1);
                const maxDoseTotal = (selectedDrug.maxDose * weight).toFixed(1);
                
                if (selectedDrug.dosesPerDay && selectedDrug.dosesPerDay > 1) {
                    const minPerDose = (minDoseTotal / selectedDrug.dosesPerDay).toFixed(1);
                    const maxPerDose = (maxDoseTotal / selectedDrug.dosesPerDay).toFixed(1);
                    
                    doseDisplay = `
                        <div style="margin-bottom: 10px;">
                            <strong>Dosis total diaria:</strong> ${minDoseTotal} - ${maxDoseTotal} ${unit}
                        </div>
                        <div>
                            <strong>Por dosis (c/${selectedDrug.dosesPerDay === 3 ? '8h' : '12-24h'}):</strong> 
                            ${minPerDose} - ${maxPerDose} ${unit}
                        </div>
                    `;
                    
                    calcDetails = `
                        <strong>C√°lculo dosis diaria:</strong><br>
                        M√≠nimo: ${selectedDrug.minDose} ${unit}/kg/d√≠a √ó ${weight} kg = ${minDoseTotal} ${unit}/d√≠a<br>
                        M√°ximo: ${selectedDrug.maxDose} ${unit}/kg/d√≠a √ó ${weight} kg = ${maxDoseTotal} ${unit}/d√≠a<br>
                        <br>
                        <strong>Divisi√≥n por dosis:</strong><br>
                        ${minDoseTotal} ${unit} √∑ ${selectedDrug.dosesPerDay} = ${minPerDose} ${unit}/dosis<br>
                        ${maxDoseTotal} ${unit} √∑ ${selectedDrug.dosesPerDay} = ${maxPerDose} ${unit}/dosis
                    `;
                } else {
                    doseDisplay = `${minDoseTotal} - ${maxDoseTotal} ${unit} al d√≠a`;
                    
                    calcDetails = `
                        <strong>C√°lculo:</strong><br>
                        M√≠nimo: ${selectedDrug.minDose} ${unit}/kg/d√≠a √ó ${weight} kg = ${minDoseTotal} ${unit}<br>
                        M√°ximo: ${selectedDrug.maxDose} ${unit}/kg/d√≠a √ó ${weight} kg = ${maxDoseTotal} ${unit}
                    `;
                }
            } else {
                // Medicamentos con dosis por toma
                const minDoseTotal = (selectedDrug.minDose * weight).toFixed(1);
                const maxDoseTotal = (selectedDrug.maxDose * weight).toFixed(1);
                
                doseDisplay = `${minDoseTotal} - ${maxDoseTotal} ${unit} por dosis`;
                
                calcDetails = `
                    <strong>C√°lculo:</strong><br>
                    M√≠nimo: ${selectedDrug.minDose} ${unit}/kg √ó ${weight} kg = ${minDoseTotal} ${unit}<br>
                    M√°ximo: ${selectedDrug.maxDose} ${unit}/kg √ó ${weight} kg = ${maxDoseTotal} ${unit}
                `;
            }

            calculationResult.innerHTML = `
                <h3>C√°lculo para paciente de ${weight} kg</h3>
                <div class="dose-range">
                    ${doseDisplay}
                </div>
                <div class="calc-details">
                    ${calcDetails}
                    <br><br>
                    <strong>Intervalo:</strong> ${selectedDrug.interval}<br>
                    <strong>‚ö†Ô∏è Recordatorio:</strong> Siempre verificar dosis m√°xima diaria y ajustar seg√∫n condici√≥n cl√≠nica
                </div>
            `;
            
            calculationResult.style.display = 'block';
        }

        // Service Worker para funcionalidad offline
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdwZWRpYXRyaWMtZG9zZS1jYWxjLXYxJzsKY29uc3QgdXJsc1RvQ2FjaGUgPSBbCiAgJy4vJywKXTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGV2ZW50ID0+IHsKICBldmVudC53YWl0VW50aWwoY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkudGhlbihjYWNoZSA9PiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpKSk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aChjYWNoZXMubWF0Y2goZXZlbnQucmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KSkpOwp9KTs=')
                .then(() => console.log('SW registrado'))
                .catch(() => console.log('Error en SW'));
        }

        // Detector de conexi√≥n
        function updateConnectionStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (navigator.onLine) {
                indicator.classList.remove('offline');
            } else {
                indicator.classList.add('offline');
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        // Inicializar la aplicaci√≥n
        window.addEventListener('DOMContentLoaded', async () => {
            await loadMedications();
            setupEventListeners();
            updateConnectionStatus();
        });
    </script>
</body>
</html>
